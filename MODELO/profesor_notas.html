<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Notas</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="panel">
    <h2>Registro de Notas</h2>
    <h3 id="cursoSeleccionado"></h3>

    <table border="1" style="width:100%; text-align:center;">
      <thead>
        <tr>
          <th>Alumno</th>
          <th>Cont. 1</th>
          <th>Parcial 1</th>
          <th>Cont. 2</th>
          <th>Parcial 2</th>
          <th>Cont. 3</th>
          <th>Final</th>
          <th>Promedio</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="tablaNotas"></tbody>
    </table>

    <br>
    <button onclick="guardarNotas()">üíæ Guardar Notas</button>
    <button onclick="volver()">‚¨ÖÔ∏è Volver al panel</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Mostrar el curso seleccionado desde localStorage
      const curso = localStorage.getItem("cursoSeleccionado");
      document.getElementById("cursoSeleccionado").innerText = "Curso: " + (curso || "No especificado");

      // Cargar los nombres de alumnos desde el archivo CSV
      fetch("notas.csv")
        .then(response => response.text())
        .then(data => {
          const lineas = data.trim().split("\n").slice(1); // Saltar la cabecera
          const tbody = document.getElementById("tablaNotas");

          lineas.forEach(linea => {
            const columnas = linea.split(",");
            const alumno = columnas[0].trim(); // Nombre del alumno

            const fila = document.createElement("tr");

            // Columna nombre
            const tdNombre = document.createElement("td");
            tdNombre.textContent = alumno;
            fila.appendChild(tdNombre);

            // Crear 6 inputs para notas
            for (let i = 0; i < 6; i++) {
              const td = document.createElement("td");
              const input = document.createElement("input");
              input.type = "number";
              input.min = "0";
              input.max = "20";
              input.value = "";
              input.addEventListener("input", calcularPromedios);
              td.appendChild(input);
              fila.appendChild(td);
            }

            // Promedio
            const tdPromedio = document.createElement("td");
            tdPromedio.classList.add("promedio");
            tdPromedio.textContent = "0";
            fila.appendChild(tdPromedio);

            // Estado
            const tdEstado = document.createElement("td");
            tdEstado.classList.add("estado");
            tdEstado.textContent = "---";
            fila.appendChild(tdEstado);

            tbody.appendChild(fila);
          });
        })
        .catch(err => {
          console.error("Error al cargar el CSV:", err);
          alert("No se pudo cargar el archivo notas.csv");
        });
    });

    // Calcular promedios autom√°ticamente
    function calcularPromedios() {
      const filas = document.querySelectorAll("#tablaNotas tr");
      filas.forEach(fila => {
        const notas = Array.from(fila.querySelectorAll("input")).map(i => parseFloat(i.value) || 0);
        const promedio = (notas.reduce((a,b)=>a+b,0) / notas.length).toFixed(2);
        const promElem = fila.querySelector(".promedio");
        const estadoElem = fila.querySelector(".estado");
        promElem.textContent = promedio;
        estadoElem.textContent = promedio >= 13 ? "Aprobado" : "Desaprobado";
        estadoElem.style.color = promedio >= 13 ? "green" : "red";
      });
    }

    // Guardar notas en un nuevo CSV descargable
    function guardarNotas() {
      const filas = document.querySelectorAll("#tablaNotas tr");
      let csv = "Alumno,Cont1,Parcial1,Cont2,Parcial2,Cont3,Final,Promedio,Estado\n";

      filas.forEach(fila => {
        const alumno = fila.cells[0].innerText;
        const notas = Array.from(fila.querySelectorAll("input")).map(i => i.value);
        const promedio = fila.querySelector(".promedio").textContent;
        const estado = fila.querySelector(".estado").textContent;
        csv += `${[alumno, ...notas, promedio, estado].join(",")}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "notas_actualizadas.csv";
      a.click();
      alert("Notas guardadas correctamente.");
    }

    function volver() {
      window.location.href = "profesor.html";
    }
  </script>
</body>
</html>
